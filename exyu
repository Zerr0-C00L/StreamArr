#!/bin/bash
# EXYU Balkan VOD Importer
# Downloads and imports VOD content from Balkan M3U playlist

set -e

M3U_URL="https://raw.githubusercontent.com/Zerr0-C00L/public-files/refs/heads/main/balkan_vod.m3u"
TEMP_FILE="/tmp/balkan_vod_exyu.m3u"
LOG_FILE="./logs/exyu-import.log"

echo "=== EXYU Balkan VOD Import Started: $(date) ===" | tee -a "$LOG_FILE"

# Download M3U file
echo "Downloading M3U file from $M3U_URL..." | tee -a "$LOG_FILE"
curl -s -L -o "$TEMP_FILE" "$M3U_URL"

if [ ! -f "$TEMP_FILE" ]; then
    echo "ERROR: Failed to download M3U file" | tee -a "$LOG_FILE"
    exit 1
fi

# Check file size
FILE_SIZE=$(wc -c < "$TEMP_FILE")
echo "Downloaded M3U file: $FILE_SIZE bytes" | tee -a "$LOG_FILE"

if [ "$FILE_SIZE" -lt 100 ]; then
    echo "ERROR: M3U file too small, might be empty or invalid" | tee -a "$LOG_FILE"
    exit 1
fi

# Count entries
MOVIE_COUNT=$(grep -c "#EXTINF" "$TEMP_FILE" || true)
echo "Found $MOVIE_COUNT entries in M3U file" | tee -a "$LOG_FILE"

# Create a temporary source config for this M3U
echo "Creating temporary import configuration..." | tee -a "$LOG_FILE"

# Call the import API endpoint directly
# We'll trigger the import by placing the M3U file in the expected location
# and updating the settings to include this source

# Copy M3U to a location the importer can access
cp "$TEMP_FILE" ./channels/balkan_vod_exyu.m3u
echo "M3U file placed in channels/balkan_vod_exyu.m3u" | tee -a "$LOG_FILE"

# Trigger import via API call to the server
# This assumes the server is running on localhost:8080
echo "Triggering VOD import..." | tee -a "$LOG_FILE"

# We need to update the settings to add this M3U source
# Create a JSON payload for the API

cat > /tmp/exyu_import.json <<EOF
{
  "m3u_url": "file://$(pwd)/channels/balkan_vod_exyu.m3u",
  "name": "EXYU Balkan VOD"
}
EOF

# Try to trigger import
# Note: You may need to manually add this to settings or trigger via UI
echo ""
echo "=== Import Configuration Ready ===" | tee -a "$LOG_FILE"
echo "M3U file downloaded to: ./channels/balkan_vod_exyu.m3u" | tee -a "$LOG_FILE"
echo "Entries found: $MOVIE_COUNT" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "To complete the import:" | tee -a "$LOG_FILE"
echo "1. Go to Settings â†’ IPTV/VOD Sources" | tee -a "$LOG_FILE"
echo "2. Add a new M3U source with URL: file://$(pwd)/channels/balkan_vod_exyu.m3u" | tee -a "$LOG_FILE"
echo "3. Or add URL: $M3U_URL" | tee -a "$LOG_FILE"
echo "4. Click 'Import' to start importing VOD content" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# Alternative: Try to add the source directly via settings file if it exists
if [ -f "./config/settings.json" ]; then
    echo "Attempting to add source to settings..." | tee -a "$LOG_FILE"
    # Backup settings
    cp ./config/settings.json ./config/settings.json.backup
    
    # Add the M3U source (this is a simple approach, may need adjustment)
    echo "Settings backed up to ./config/settings.json.backup" | tee -a "$LOG_FILE"
    echo "Please manually add the M3U source in the UI" | tee -a "$LOG_FILE"
fi

echo "=== EXYU Balkan VOD Import Script Completed: $(date) ===" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# Clean up temp file
rm -f "$TEMP_FILE"
